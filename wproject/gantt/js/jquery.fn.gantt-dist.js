!function($,undefined){"use strict";function findDay(elt,text){var cd=new Date(parseInt(text,10));cd.setHours(0,0,0,0);var id=$(elt).attr("id")||"",si=id.indexOf("-")+1,ed=new Date(parseInt(id.substring(si,id.length),10));return ed.setHours(0,0,0,0),cd.getTime()===ed.getTime()}function findWeek(elt,text){var cd=new Date(parseInt(text,10)),y=cd.getFullYear(),w=cd.getWeekOfYear(),m=cd.getMonth();11===m&&1===w?y++:!m&&51<w&&y--,cd=y+"-"+w;var id=$(elt).attr("id")||"",si=id.indexOf("-")+1;return cd===id.substring(si,id.length)}function findMonth(elt,text){var cd=new Date(parseInt(text,10));cd=cd.getFullYear()+"-"+cd.getMonth();var id=$(elt).attr("id")||"",si=id.indexOf("-")+1;return cd===id.substring(si,id.length)}$.expr.pseudos.findday=$.expr.createPseudo?$.expr.createPseudo(function(text){return function(elt){return findDay(elt,text)}}):function(elt,i,match){return findDay(elt,match[3])},$.expr.pseudos.findweek=$.expr.createPseudo?$.expr.createPseudo(function(text){return function(elt){return findWeek(elt,text)}}):function(elt,i,match){return findWeek(elt,match[3])},$.expr[":"].findmonth=$.expr.createPseudo?$.expr.createPseudo(function(text){return function(elt){return findMonth(elt,text)}}):function(elt,i,match){return findMonth(elt,match[3])},Date.prototype.getWeekId=function(){var y=this.getFullYear(),w=this.getWeekOfYear(),m=this.getMonth();return 11===m&&1===w?y++:!m&&51<w&&y--,"dh-"+y+"-"+w},Date.prototype.getRepDate=function(scale){switch(scale){case"hours":return this.getTime();case"weeks":return this.getDayForWeek().getTime();case"months":return new Date(this.getFullYear(),this.getMonth(),1).getTime();case"days":default:return this.getTime()}},Date.prototype.getDayOfYear=function(){var year=this.getFullYear();return(Date.UTC(year,this.getMonth(),this.getDate())-Date.UTC(year,0,0))/864e5};Date.prototype.getWeekOfYear=function(){var year=this.getFullYear(),month=this.getMonth(),date=this.getDate(),day=this.getDay(),diff=4-day;return day<1&&(diff-=7),diff+7<3&&(diff+=7),Math.ceil(new Date(year,month,date+diff).getDayOfYear()/7)},Date.prototype.getDayForWeek=function(){var day=this.getDay(),diff=1+(day<1?-7:0)-day;return new Date(this.getFullYear(),this.getMonth(),this.getDate()+diff)},$.fn.gantt=function(options){var scales=["hours","days","weeks","months"],settings={source:[],holidays:[],itemsPerPage:7,dow:["S","M","T","W","T","F","S"],months:["January","February","March","April","May","June","July","August","September","October","November","December"],waitText:"Please wait...",navigate:"buttons",scrollToToday:!0,useCookie:!1,cookieKey:"jquery.fn.gantt",scale:"days",maxScale:"months",minScale:"hours",onItemClick:function(data){},onAddClick:function(dt,rowId){},onRender:$.noop};$.extend(settings,options),settings.useCookie=settings.useCookie&&$.isFunction($.cookie);var core={elementFromPoint:"CSS1Compat"===document.compatMode?function(x,y){return x-=window.pageXOffset,y-=window.pageYOffset,document.elementFromPoint(x,y)}:function(x,y){return x-=$(document).scrollLeft(),y-=$(document).scrollTop(),document.elementFromPoint(x,y)},create:function(element){"string"!=typeof settings.source?(element.data=settings.source,core.init(element)):$.getJSON(settings.source,function(jsData){element.data=jsData,core.init(element)})},init:function(element){element.rowsNum=element.data.length,element.pageCount=Math.ceil(element.rowsNum/settings.itemsPerPage),element.rowsOnLastPage=element.rowsNum-Math.floor(element.rowsNum/settings.itemsPerPage)*settings.itemsPerPage,element.dateStart=tools.getMinDate(element),element.dateEnd=tools.getMaxDate(element),core.waitToggle(element,function(){core.render(element)})},render:function(element){var content=$('<div class="fn-content"/>'),$leftPanel=core.leftPanel(element);content.append($leftPanel);var hPos,$rightPanel=core.rightPanel(element,$leftPanel);content.append($rightPanel),content.append(core.navigation(element));var $dataPanel=$rightPanel.find(".dataPanel");if(element.gantt=$('<div class="fn-gantt" />').append(content),$(element).empty().append(element.gantt),element.scrollNavigation.panelMargin=parseInt($dataPanel.css("left").replace("px",""),10),element.scrollNavigation.panelMaxPos=$dataPanel.width()-$rightPanel.width(),element.scrollNavigation.canScroll=$dataPanel.width()>$rightPanel.width(),core.markNow(element),core.fillData(element,$dataPanel,$leftPanel),settings.useCookie){var sc=$.cookie(settings.cookieKey+"ScrollPos");sc&&(element.hPosition=sc)}settings.scrollToToday?(core.navigateTo(element,"now"),core.scrollPanel(element,0)):(0!==element.hPosition&&(element.scaleOldWidth&&(hPos=($dataPanel.width()-$rightPanel.width())*element.hPosition/element.scaleOldWidth,element.hPosition=0<hPos?0:hPos,element.scaleOldWidth=null),$dataPanel.css({left:element.hPosition}),element.scrollNavigation.panelMargin=element.hPosition),core.repositionLabel(element)),$dataPanel.css({height:$leftPanel.height()}),core.waitToggle(element),settings.onRender()},leftPanel:function(element){var ganttLeftPanel=$('<div class="leftPanel"/>').append($('<div class="row spacer"/>').css("height",tools.getCellSize()*element.headerRows)),entries=[];return $.each(element.data,function(i,entry){if(i>=element.pageNum*settings.itemsPerPage&&i<element.pageNum*settings.itemsPerPage+settings.itemsPerPage){var dataId="id"in entry?'" data-id="'+entry.id:"";entries.push('<div class="row name row'+i+(entry.desc?"":" fn-wide "+dataId)+'" id="rowheader'+i+'" data-offset="'+i%settings.itemsPerPage*tools.getCellSize()+'"><span class="fn-label'+(entry.cssClass?" "+entry.cssClass:"")+'">'+(entry.name||"")+"</span></div>"),entry.desc&&entries.push('<div class="row desc row'+i+' " id="RowdId_'+i+dataId+'"><span class="fn-label'+(entry.cssClass?" "+entry.cssClass:"")+'">'+entry.desc+"</span></div>")}}),ganttLeftPanel.append(entries.join(""))},dataPanel:function(element,width){var dataPanel=$('<div class="dataPanel" style="width: '+width+'px;"/>');return dataPanel.click(function(e){var corrY;e.stopPropagation();var leftpanel=$(element).find(".fn-gantt .leftPanel"),datapanel=$(element).find(".fn-gantt .dataPanel");switch(settings.scale){case"months":corrY=tools.getCellSize();break;case"hours":corrY=4*tools.getCellSize();break;case"days":corrY=3*tools.getCellSize();break;case"weeks":default:corrY=2*tools.getCellSize()}var col=core.elementFromPoint(e.pageX,datapanel.offset().top+corrY),dt=(col="fn-label"===col.className?$(col.parentNode):$(col)).data("repdate"),row=core.elementFromPoint(leftpanel.offset().left+leftpanel.width()-10,e.pageY),rowId=(row=0===row.className.indexOf("fn-label")?$(row.parentNode):$(row)).data("id");settings.onAddClick(dt,rowId)}),dataPanel},rightPanel:function(element,leftPanel){var range=null,dowClass=["sn","wd","wd","wd","wd","wd","sa"],yearArr=[],scaleUnitsThisYear=0,monthArr=[],scaleUnitsThisMonth=0,dayArr=[],hoursInDay=0,dowArr=[],horArr=[],today=new Date;today.setHours(0,0,0,0);var i,len,year,month,week,day,rday,dayClass,dataPanel,dataPanelWidth,$row=$('<div class="row header"></div>');switch(settings.scale){case"hours":for(dataPanelWidth=(range=tools.parseTimeRange(element.dateStart,element.dateEnd,element.scaleStep)).length*tools.getCellSize(),year=range[0].getFullYear(),month=range[0].getMonth(),day=range[0],i=0,len=range.length;i<len;i++){var rfy=(rday=range[i]).getFullYear();rfy!==year&&(yearArr.push('<div class="row year" style="width: '+tools.getCellSize()*scaleUnitsThisYear+'px;"><div class="fn-label">'+year+"</div></div>"),year=rfy,scaleUnitsThisYear=0),scaleUnitsThisYear++;var rm=rday.getMonth();rm!==month&&(monthArr.push('<div class="row month" style="width: '+tools.getCellSize()*scaleUnitsThisMonth+'px"><div class="fn-label">'+settings.months[month]+"</div></div>"),month=rm,scaleUnitsThisMonth=0),scaleUnitsThisMonth++;var rgetDay=rday.getDay(),getDay=day.getDay();rgetDay!==getDay&&(dayClass=today-day==0?"today":tools.isHoliday(day.getTime())?"holiday":dowClass[getDay],dayArr.push('<div class="row date '+dayClass+'" style="width: '+tools.getCellSize()*hoursInDay+'px;"><div class="fn-label">'+day.getDate()+"</div></div>"),dowArr.push('<div class="row day '+dayClass+'" style="width: '+tools.getCellSize()*hoursInDay+'px;"><div class="fn-label">'+settings.dow[getDay]+"</div></div>"),day=rday,hoursInDay=0),hoursInDay++,dayClass=dowClass[rgetDay],tools.isHoliday(rday)&&(dayClass="holiday"),horArr.push('<div class="row day '+dayClass+'" id="dh-'+rday.getTime()+'" data-offset="'+i*tools.getCellSize()+'" data-repdate="'+rday.getRepDate(settings.scale)+'"><div class="fn-label">'+rday.getHours()+"</div></div>")}yearArr.push('<div class="row year" style="width: '+tools.getCellSize()*scaleUnitsThisYear+'px;"><div class="fn-label">'+year+"</div></div>"),monthArr.push('<div class="row month" style="width: '+tools.getCellSize()*scaleUnitsThisMonth+'px"><div class="fn-label">'+settings.months[month]+"</div></div>"),dayClass=dowClass[day.getDay()],tools.isHoliday(day)&&(dayClass="holiday"),dayArr.push('<div class="row date '+dayClass+'" style="width: '+tools.getCellSize()*hoursInDay+'px;"><div class="fn-label">'+day.getDate()+"</div></div>"),dowArr.push('<div class="row day '+dayClass+'" style="width: '+tools.getCellSize()*hoursInDay+'px;"><div class="fn-label">'+settings.dow[day.getDay()]+"</div></div>"),(dataPanel=core.dataPanel(element,dataPanelWidth)).append($row.clone().html(yearArr.join("")),$row.clone().html(monthArr.join("")),$row.clone().html(dayArr.join("")),$row.clone().html(dowArr.join("")),$row.clone().html(horArr.join("")));break;case"weeks":var diff;for(dataPanelWidth=(range=tools.parseWeeksRange(element.dateStart,element.dateEnd)).length*tools.getCellSize(),year=range[0].getFullYear(),month=range[0].getMonth(),week=range[0].getWeekOfYear(),i=0,len=range.length;i<len;i++)week>(week=(rday=range[i]).getWeekOfYear())&&(diff=rday.getDate()-1,diff-=rday.getMonth()?31:0,diff/=7,yearArr.push('<div class="row year" style="width: '+tools.getCellSize()*(scaleUnitsThisYear-diff)+'px;"><div class="fn-label">'+year+"</div></div>"),year++,scaleUnitsThisYear=diff),scaleUnitsThisYear++,rday.getMonth()!==month&&(diff=rday.getDate()-1,diff/=7,monthArr.push('<div class="row month" style="width:'+tools.getCellSize()*(scaleUnitsThisMonth-diff)+'px;"><div class="fn-label">'+settings.months[month]+"</div></div>"),month=rday.getMonth(),scaleUnitsThisMonth=diff),scaleUnitsThisMonth++,dayArr.push('<div class="row day wd" id="'+rday.getWeekId()+'" data-offset="'+i*tools.getCellSize()+'" data-repdate="'+rday.getRepDate(settings.scale)+'"><div class="fn-label">'+week+"</div></div>");yearArr.push('<div class="row year" style="width: '+tools.getCellSize()*scaleUnitsThisYear+'px;"><div class="fn-label">'+year+"</div></div>"),monthArr.push('<div class="row month" style="width: '+tools.getCellSize()*scaleUnitsThisMonth+'px"><div class="fn-label">'+settings.months[month]+"</div></div>"),(dataPanel=core.dataPanel(element,dataPanelWidth)).append($row.clone().html(yearArr.join("")),$row.clone().html(monthArr.join("")),$row.clone().html(dayArr.join("")));break;case"months":for(dataPanelWidth=(range=tools.parseMonthsRange(element.dateStart,element.dateEnd)).length*tools.getCellSize(),year=range[0].getFullYear(),month=range[0].getMonth(),i=0,len=range.length;i<len;i++)(rday=range[i]).getFullYear()!==year&&(yearArr.push('<div class="row year" style="width: '+tools.getCellSize()*scaleUnitsThisYear+'px;"><div class="fn-label">'+year+"</div></div>"),year=rday.getFullYear(),scaleUnitsThisYear=0),scaleUnitsThisYear++,monthArr.push('<div class="row day wd" id="dh-'+tools.genId(rday)+'" data-offset="'+i*tools.getCellSize()+'" data-repdate="'+rday.getRepDate(settings.scale)+'">'+(1+rday.getMonth())+"</div>");yearArr.push('<div class="row year" style="width: '+tools.getCellSize()*scaleUnitsThisYear+'px;"><div class="fn-label">'+year+"</div></div>"),(dataPanel=core.dataPanel(element,dataPanelWidth)).append($row.clone().html(yearArr.join("")),$row.clone().html(monthArr.join("")));break;default:for(dataPanelWidth=(range=tools.parseDateRange(element.dateStart,element.dateEnd)).length*tools.getCellSize(),year=range[0].getFullYear(),month=range[0].getMonth(),i=0,len=range.length;i<len;i++)(rday=range[i]).getFullYear()!==year&&(yearArr.push('<div class="row year" style="width:'+tools.getCellSize()*scaleUnitsThisYear+'px;"><div class="fn-label">'+year+"</div></div>"),year=rday.getFullYear(),scaleUnitsThisYear=0),scaleUnitsThisYear++,rday.getMonth()!==month&&(monthArr.push('<div class="row month" style="width:'+tools.getCellSize()*scaleUnitsThisMonth+'px;"><div class="fn-label">'+settings.months[month]+"</div></div>"),month=rday.getMonth(),scaleUnitsThisMonth=0),scaleUnitsThisMonth++,dayClass=dowClass[day=rday.getDay()],tools.isHoliday(rday)&&(dayClass="holiday"),dayArr.push('<div class="row date '+dayClass+'" id="dh-'+tools.genId(rday)+'" data-offset="'+i*tools.getCellSize()+'" data-repdate="'+rday.getRepDate(settings.scale)+'"><div class="fn-label">'+rday.getDate()+"</div></div>"),dowArr.push('<div class="row day '+dayClass+'" id="dw-'+tools.genId(rday)+'" data-repdate="'+rday.getRepDate(settings.scale)+'"><div class="fn-label">'+settings.dow[day]+"</div></div>");yearArr.push('<div class="row year" style="width: '+tools.getCellSize()*scaleUnitsThisYear+'px;"><div class="fn-label">'+year+"</div></div>"),monthArr.push('<div class="row month" style="width: '+tools.getCellSize()*scaleUnitsThisMonth+'px"><div class="fn-label">'+settings.months[month]+"</div></div>"),(dataPanel=core.dataPanel(element,dataPanelWidth)).append($row.clone().html(yearArr.join("")),$row.clone().html(monthArr.join("")),$row.clone().html(dayArr.join("")),$row.clone().html(dowArr.join("")))}return $('<div class="rightPanel"></div>').append(dataPanel)},navigation:function(element){var ganttNavigate=null;return"scroll"===settings.navigate?(ganttNavigate=$('<div class="navigate" />').append($('<div class="nav-slider" />').append($('<div class="nav-slider-left" />').append($('<button type="button" class="nav-link nav-page-back"/>').html("&uarr;").click(function(){core.navigatePage(element,-1)})).append($('<div class="page-number"/>').append($("<span/>").html(element.pageNum+1+" / "+element.pageCount))).append($('<button type="button" class="nav-link nav-page-next"/>').html("&darr;").click(function(){core.navigatePage(element,1)})).append($('<button type="button" class="nav-link nav-now"/>').html("&#9679;").click(function(){core.navigateTo(element,"now")})).append($('<button type="button" class="nav-link nav-prev-week"/>').html("&lt;&lt;").click(function(){"hours"===settings.scale?core.navigateTo(element,8*tools.getCellSize()):"days"===settings.scale?core.navigateTo(element,30*tools.getCellSize()):"weeks"===settings.scale?core.navigateTo(element,12*tools.getCellSize()):"months"===settings.scale&&core.navigateTo(element,6*tools.getCellSize())})).append($('<button type="button" class="nav-link nav-prev-day"/>').html("&lt;").click(function(){"hours"===settings.scale?core.navigateTo(element,4*tools.getCellSize()):"days"===settings.scale?core.navigateTo(element,7*tools.getCellSize()):"weeks"===settings.scale?core.navigateTo(element,4*tools.getCellSize()):"months"===settings.scale&&core.navigateTo(element,3*tools.getCellSize())}))).append($('<div class="nav-slider-content" />').append($('<div class="nav-slider-bar" />').append($('<a class="nav-slider-button" />')).mousedown(function(e){e.preventDefault(),element.scrollNavigation.scrollerMouseDown=!0,core.sliderScroll(element,e)}).mousemove(function(e){element.scrollNavigation.scrollerMouseDown&&core.sliderScroll(element,e)}))).append($('<div class="nav-slider-right" />').append($('<button type="button" class="nav-link nav-next-day"/>').html("&gt;").click(function(){"hours"===settings.scale?core.navigateTo(element,-4*tools.getCellSize()):"days"===settings.scale?core.navigateTo(element,-7*tools.getCellSize()):"weeks"===settings.scale?core.navigateTo(element,-4*tools.getCellSize()):"months"===settings.scale&&core.navigateTo(element,-3*tools.getCellSize())})).append($('<button type="button" class="nav-link nav-next-week"/>').html("&gt;&gt;").click(function(){"hours"===settings.scale?core.navigateTo(element,-8*tools.getCellSize()):"days"===settings.scale?core.navigateTo(element,-30*tools.getCellSize()):"weeks"===settings.scale?core.navigateTo(element,-12*tools.getCellSize()):"months"===settings.scale&&core.navigateTo(element,-6*tools.getCellSize())})).append($('<button type="button" class="nav-link nav-zoomIn"/>').html("&#43;").click(function(){core.zoomInOut(element,-1)})).append($('<button type="button" class="nav-link nav-zoomOut"/>').html("&#45;").click(function(){core.zoomInOut(element,1)})))),$(document).mouseup(function(){element.scrollNavigation.scrollerMouseDown=!1})):ganttNavigate=$('<div class="navigate" />').append($('<button type="button" class="nav-link nav-page-back"/>').html("&uarr;").click(function(){core.navigatePage(element,-1)})).append($('<div class="page-number"/>').append($("<span/>").html(element.pageNum+1+" / "+element.pageCount))).append($('<button type="button" class="nav-link nav-page-next"/>').html("&darr;").click(function(){core.navigatePage(element,1)})).append($('<button type="button" class="nav-link nav-begin"/>').html("&#124;&lt;").click(function(){core.navigateTo(element,"begin")})).append($('<button type="button" class="nav-link nav-prev-week"/>').html("&lt;&lt;").click(function(){core.navigateTo(element,7*tools.getCellSize())})).append($('<button type="button" class="nav-link nav-prev-day"/>').html("&lt;").click(function(){core.navigateTo(element,tools.getCellSize())})).append($('<button type="button" class="nav-link nav-now"/>').html("&#9679;").click(function(){core.navigateTo(element,"now")})).append($('<button type="button" class="nav-link nav-next-day"/>').html("&gt;").click(function(){core.navigateTo(element,-1*tools.getCellSize())})).append($('<button type="button" class="nav-link nav-next-week"/>').html("&gt;&gt;").click(function(){core.navigateTo(element,-7*tools.getCellSize())})).append($('<button type="button" class="nav-link nav-end"/>').html("&gt;&#124;").click(function(){core.navigateTo(element,"end")})).append($('<button type="button" class="nav-link nav-zoomIn"/>').html("&#43;").click(function(){core.zoomInOut(element,-1)})).append($('<button type="button" class="nav-link nav-zoomOut"/>').html("&#45;").click(function(){core.zoomInOut(element,1)})),$('<div class="bottom"></div>').append(ganttNavigate)},createProgressBar:function(label,desc,classNames,dataObj){var bar=$('<div class="bar"><div class="fn-label">'+(label=label||"")+"</div></div>").data("dataObj",dataObj);return desc&&bar.mouseenter(function(e){var hint=$('<div class="fn-gantt-hint" />').html(desc);$("body").append(hint),hint.css("left",e.pageX),hint.css("top",e.pageY),hint.show()}).mouseleave(function(){$(".fn-gantt-hint").remove()}).mousemove(function(e){$(".fn-gantt-hint").css("left",e.pageX),$(".fn-gantt-hint").css("top",e.pageY+15)}),classNames&&bar.addClass(classNames),bar.click(function(e){e.stopPropagation(),settings.onItemClick($(this).data("dataObj"))}),bar},markNow:function(element){var cd=(new Date).setHours(0,0,0,0);switch(settings.scale){case"weeks":$(element).find(':findweek("'+cd+'")').removeClass("wd").addClass("today");break;case"months":$(element).find(':findmonth("'+cd+'")').removeClass("wd").addClass("today");break;case"days":case"hours":default:$(element).find(':findday("'+cd+'")').removeClass("wd").addClass("today")}},fillData:function(element,datapanel,leftpanel){var cellWidth=tools.getCellSize(),barOffset=(cellWidth-18)/2,dataPanelWidth=datapanel.width();$.each(element.data,function(i,entry){i>=element.pageNum*settings.itemsPerPage&&i<element.pageNum*settings.itemsPerPage+settings.itemsPerPage&&$.each(entry.values,function(j,day){var _bar,from,to,cFrom,cTo,dFrom,dTo,dl,dp,topEl,top;switch(settings.scale){case"hours":dFrom=tools.genId(tools.dateDeserialize(day.from),element.scaleStep),from=$(element).find("#dh-"+dFrom),dTo=tools.genId(tools.dateDeserialize(day.to),element.scaleStep),to=$(element).find("#dh-"+dTo),cFrom=from.data("offset"),cTo=to.data("offset"),dl=Math.floor((cTo-cFrom)/cellWidth)+1,dp=100*(cellWidth*dl-1)/dataPanelWidth,_bar=core.createProgressBar(day.label,day.desc,day.customClass,day.dataObj),topEl=$(element).find("#rowheader"+i),top=5*cellWidth+barOffset+topEl.data("offset"),_bar.css({top:top,left:Math.floor(cFrom),width:dp+"%"}),datapanel.append(_bar);break;case"weeks":dFrom=tools.dateDeserialize(day.from),dTo=tools.dateDeserialize(day.to),cFrom=(from=$(element).find("#"+dFrom.getWeekId())).data("offset"),cTo=(to=$(element).find("#"+dTo.getWeekId())).data("offset"),dl=Math.round((cTo-cFrom)/cellWidth)+1,dp=100*(cellWidth*dl-1)/dataPanelWidth,_bar=core.createProgressBar(day.label,day.desc,day.customClass,day.dataObj),topEl=$(element).find("#rowheader"+i),top=3*cellWidth+barOffset+topEl.data("offset"),_bar.css({top:top,left:Math.floor(cFrom),width:dp+"%"}),datapanel.append(_bar);break;case"months":dFrom=tools.dateDeserialize(day.from),dTo=tools.dateDeserialize(day.to),dFrom.getDate()<=3&&0===dFrom.getMonth()&&dFrom.setDate(dFrom.getDate()+4),dFrom.getDate()<=3&&0===dFrom.getMonth()&&dFrom.setDate(dFrom.getDate()+4),dTo.getDate()<=3&&0===dTo.getMonth()&&dTo.setDate(dTo.getDate()+4),cFrom=(from=$(element).find("#dh-"+tools.genId(dFrom))).data("offset"),cTo=(to=$(element).find("#dh-"+tools.genId(dTo))).data("offset"),dl=Math.round((cTo-cFrom)/cellWidth)+1,dp=100*(cellWidth*dl-1)/dataPanelWidth,_bar=core.createProgressBar(day.label,day.desc,day.customClass,day.dataObj),topEl=$(element).find("#rowheader"+i),top=2*cellWidth+barOffset+topEl.data("offset"),_bar.css({top:top,left:Math.floor(cFrom),width:dp+"%"}),datapanel.append(_bar);break;case"days":default:dFrom=tools.genId(tools.dateDeserialize(day.from)),dTo=tools.genId(tools.dateDeserialize(day.to)),cFrom=(from=$(element).find("#dh-"+dFrom)).data("offset"),dl=Math.round((dTo-dFrom)/864e5)+1,dp=100*(cellWidth*dl-1)/dataPanelWidth,_bar=core.createProgressBar(day.label,day.desc,day.customClass,day.dataObj),topEl=$(element).find("#rowheader"+i),top=4*cellWidth+barOffset+topEl.data("offset"),_bar.css({top:top,left:Math.floor(cFrom),width:dp+"%"}),datapanel.append(_bar)}var $l=_bar.find(".fn-label");if($l.length){var gray=function(colStr){try{var rgbArr=(colStr=colStr.replace("rgb(","").replace(")","")).split(","),R=parseInt(rgbArr[0],10),G=parseInt(rgbArr[1],10),B=parseInt(rgbArr[2],10),gray=Math.round(.9*(255-(.299*R+.587*G+.114*B)));return"rgb("+gray+", "+gray+", "+gray+")"}catch(err){return""}}(_bar.css("backgroundColor"));$l.css("color",gray)}})})},navigateTo:function(element,val){var maxLeft,curLeft,$rightPanel=$(element).find(".fn-gantt .rightPanel"),$dataPanel=$rightPanel.find(".dataPanel"),rightPanelWidth=$rightPanel.width(),dataPanelWidth=$dataPanel.width(),shift=function(){core.repositionLabel(element)};switch(val){case"begin":$dataPanel.animate({left:"0"},"fast",shift),element.scrollNavigation.panelMargin=0;break;case"end":var pLeft=dataPanelWidth-rightPanelWidth;element.scrollNavigation.panelMargin=-1*pLeft,$dataPanel.animate({left:"-"+pLeft},"fast",shift);break;case"now":if(!element.scrollNavigation.canScroll||!$dataPanel.find(".today").length)return!1;maxLeft=-1*(dataPanelWidth-rightPanelWidth),curLeft=$dataPanel.css("left").replace("px",""),val=$dataPanel.find(".today").offset().left-$dataPanel.offset().left,0<(val*=-1)?val=0:val<maxLeft&&(val=maxLeft),$dataPanel.animate({left:val},"fast",shift),element.scrollNavigation.panelMargin=val;break;default:maxLeft=-1*(dataPanelWidth-rightPanelWidth),curLeft=$dataPanel.css("left").replace("px",""),(val=parseInt(curLeft,10)+val)<=0&&maxLeft<=val&&$dataPanel.animate({left:val},"fast",shift),element.scrollNavigation.panelMargin=val}core.synchronizeScroller(element)},navigatePage:function(element,val){0<=element.pageNum+val&&element.pageNum+val<Math.ceil(element.rowsNum/settings.itemsPerPage)&&core.waitToggle(element,function(){element.pageNum+=val,element.hPosition=$(".fn-gantt .dataPanel").css("left").replace("px",""),element.scaleOldWidth=!1,core.init(element)})},zoomInOut:function(element,val){core.waitToggle(element,function(){var zoomIn=val<0,scaleSt=element.scaleStep+3*val;scaleSt={4:3,5:6,9:8,11:12}[scaleSt]||(scaleSt<1?1:scaleSt);var scale=settings.scale,headerRows=element.headerRows;if("hours"===settings.scale&&13<=scaleSt?(scale="days",headerRows=4,scaleSt=13):"days"===settings.scale&&zoomIn?(scale="hours",headerRows=5,scaleSt=12):"days"!==settings.scale||zoomIn?"weeks"!==settings.scale||zoomIn?"weeks"===settings.scale&&zoomIn?(scale="days",headerRows=4,scaleSt=13):"months"===settings.scale&&zoomIn&&(scale="weeks",headerRows=3,scaleSt=13):(scale="months",headerRows=2,scaleSt=14):(scale="weeks",headerRows=3,scaleSt=13),zoomIn&&$.inArray(scale,scales)<$.inArray(settings.minScale,scales)||!zoomIn&&$.inArray(scale,scales)>$.inArray(settings.maxScale,scales))core.init(element);else{element.scaleStep=scaleSt,settings.scale=scale,element.headerRows=headerRows;var $rightPanel=$(element).find(".fn-gantt .rightPanel"),$dataPanel=$rightPanel.find(".dataPanel");element.hPosition=$dataPanel.css("left").replace("px",""),element.scaleOldWidth=$dataPanel.width()-$rightPanel.width(),settings.useCookie&&($.cookie(settings.cookieKey+"CurrentScale",settings.scale),$.cookie(settings.cookieKey+"ScrollPos",null)),core.init(element)}})},mouseScroll:function(element,e){var $dataPanel=$(element).find(".fn-gantt .dataPanel");$dataPanel.css("cursor","move");$dataPanel.offset();var mPos=null===element.scrollNavigation.mouseX?e.pageX:element.scrollNavigation.mouseX,delta=e.pageX-mPos;element.scrollNavigation.mouseX=e.pageX,core.scrollPanel(element,delta),clearTimeout(element.scrollNavigation.repositionDelay),element.scrollNavigation.repositionDelay=setTimeout(core.repositionLabel,50,element)},wheelScroll:function(element,e){e.preventDefault();var delta="detail"in e?e.detail:"wheelDelta"in e.originalEvent?-1/120*e.originalEvent.wheelDelta:e.originalEvent.deltaY?e.originalEvent.deltaY/Math.abs(e.originalEvent.deltaY):e.originalEvent.detail;core.scrollPanel(element,-50*delta),clearTimeout(element.scrollNavigation.repositionDelay),element.scrollNavigation.repositionDelay=setTimeout(core.repositionLabel,50,element)},sliderScroll:function(element,e){var pos,pLeft,$sliderBar=$(element).find(".nav-slider-bar"),$sliderBarBtn=$sliderBar.find(".nav-slider-button"),$rightPanel=$(element).find(".fn-gantt .rightPanel"),$dataPanel=$rightPanel.find(".dataPanel"),bPos=$sliderBar.offset(),bWidth=$sliderBar.width(),wButton=$sliderBarBtn.width();if(e.pageX>=bPos.left&&e.pageX<=bPos.left+bWidth){pos=e.pageX-bPos.left,pos-=wButton/2,$sliderBarBtn.css("left",pos);var pPos=pos*(pLeft=$dataPanel.width()-$rightPanel.width())/bWidth*-1;0<=pPos?($dataPanel.css("left","0"),element.scrollNavigation.panelMargin=0):bWidth-1*wButton<=pos?($dataPanel.css("left",-1*pLeft),element.scrollNavigation.panelMargin=-1*pLeft):($dataPanel.css("left",pPos),element.scrollNavigation.panelMargin=pPos),clearTimeout(element.scrollNavigation.repositionDelay),element.scrollNavigation.repositionDelay=setTimeout(core.repositionLabel,5,element)}},scrollPanel:function(element,delta){if(!element.scrollNavigation.canScroll)return!1;var _panelMargin=parseInt(element.scrollNavigation.panelMargin,10)+delta;0<_panelMargin?element.scrollNavigation.panelMargin=0:_panelMargin<-1*element.scrollNavigation.panelMaxPos?element.scrollNavigation.panelMargin=-1*element.scrollNavigation.panelMaxPos:element.scrollNavigation.panelMargin=_panelMargin,$(element).find(".fn-gantt .dataPanel").css("left",element.scrollNavigation.panelMargin),core.synchronizeScroller(element)},synchronizeScroller:function(element){if("scroll"===settings.navigate){var $rightPanel=$(element).find(".fn-gantt .rightPanel"),$dataPanel=$rightPanel.find(".dataPanel"),$sliderBar=$(element).find(".nav-slider-bar"),$sliderBtn=$sliderBar.find(".nav-slider-button"),bWidth=$sliderBar.width(),wButton=$sliderBtn.width(),pLeft=$dataPanel.width()-$rightPanel.width(),hPos=$dataPanel.css("left")||0;hPos&&(hPos=hPos.replace("px",""));var pos=hPos*bWidth/pLeft-.25*$sliderBtn.width();pos=0<pos?0:bWidth-.75*wButton<=-1*pos?-1*(bWidth-1.25*wButton):pos,$sliderBtn.css("left",-1*pos)}},repositionLabel:function(element){setTimeout(function(){var $dataPanel;element?$dataPanel=$(element).find(".fn-gantt .rightPanel").find(".dataPanel"):$dataPanel=$(".fn-gantt .rightPanel .dataPanel");settings.useCookie&&$.cookie(settings.cookieKey+"ScrollPos",$dataPanel.css("left").replace("px",""))},500)},waitToggle:function(element,showCallback){if($.isFunction(showCallback)){var $elt=$(element);$elt.offset(),$elt.outerWidth(),$elt.outerHeight();element.loader||(element.loader=$('<div class="fn-gantt-loader"><div class="fn-gantt-loader-spinner"><span>'+settings.waitText+"</span></div></div>")),$elt.append(element.loader),setTimeout(showCallback,500)}else element.loader&&element.loader.detach()}},tools={getMaxDate:function(element){var bd,maxDate=null;switch($.each(element.data,function(i,entry){$.each(entry.values,function(i,date){var toDate=tools.dateDeserialize(date.to);isNaN(toDate)||(maxDate=maxDate<toDate?toDate:maxDate)})}),maxDate=maxDate||new Date,settings.scale){case"hours":maxDate.setHours(Math.ceil(maxDate.getHours()/element.scaleStep)*element.scaleStep),maxDate.setHours(maxDate.getHours()+3*element.scaleStep);break;case"weeks":bd=new Date(maxDate.getTime()),bd=new Date(bd.setDate(bd.getDate()+21));var md=7*Math.floor(bd.getDate()/7);maxDate=new Date(bd.getFullYear(),bd.getMonth(),0===md?4:md-3);break;case"months":(bd=new Date(maxDate.getFullYear(),maxDate.getMonth(),1)).setMonth(bd.getMonth()+2),maxDate=new Date(bd.getFullYear(),bd.getMonth(),1);break;case"days":default:maxDate.setHours(0),maxDate.setDate(maxDate.getDate()+3)}return maxDate},getMinDate:function(element){var minDate=null;switch($.each(element.data,function(i,entry){$.each(entry.values,function(i,date){var fromDate=tools.dateDeserialize(date.from);isNaN(fromDate)||(minDate=fromDate<minDate||null===minDate?fromDate:minDate)})}),minDate=minDate||new Date,settings.scale){case"hours":minDate.setHours(Math.floor(minDate.getHours()/element.scaleStep)*element.scaleStep),minDate.setHours(minDate.getHours()-3*element.scaleStep);break;case"weeks":var bd=new Date(minDate.getTime());bd=new Date(bd.setDate(bd.getDate()-21));var md=7*Math.floor(bd.getDate()/7);minDate=new Date(bd.getFullYear(),bd.getMonth(),0===md?4:md-3);break;case"months":minDate.setHours(0,0,0,0),minDate.setDate(1),minDate.setMonth(minDate.getMonth()-3);break;case"days":default:minDate.setHours(0,0,0,0),minDate.setDate(minDate.getDate()-3)}return minDate},parseDateRange:function(from,to){for(var year=from.getFullYear(),month=from.getMonth(),date=from.getDate(),range=[],i=0;range[i]=new Date(year,month,date+i),range[i++]<to;);return range},parseTimeRange:function(from,to,scaleStep){var year=from.getFullYear(),month=from.getMonth(),date=from.getDate(),hour=from.getHours();hour-=hour%scaleStep;for(var range=[],h=0,i=0;range[i]=new Date(year,month,date,hour+h++*scaleStep),0<i&&range[i].getHours()===range[i-1].getHours()&&i--,range[i++]<to;);return range},parseWeeksRange:function(from,to){for(var current=from.getDayForWeek(),ret=[],i=0;ret[i++]=current.getDayForWeek(),current.setDate(current.getDate()+7),current<=to;);return ret},parseMonthsRange:function(from,to){for(var current=new Date(from),ret=(new Date(to),[]),i=0;ret[i++]=new Date(current.getFullYear(),current.getMonth(),1),current.setMonth(current.getMonth()+1),current<=to;);return ret},dateDeserialize:function(date){return"string"==typeof date&&(date=date.replace(/\/Date\((.*)\)\//,"$1"),date=$.isNumeric(date)?parseInt(date,10):$.trim(date)),new Date(date)},genId:function(t){switch($.isNumeric(t)&&(t=new Date(t)),settings.scale){case"hours":var hour=t.getHours();return 2<=arguments.length&&(hour=Math.floor(t.getHours()/arguments[1])*arguments[1]),new Date(t.getFullYear(),t.getMonth(),t.getDate(),hour).getTime();case"weeks":var y=t.getFullYear(),w=t.getWeekOfYear(),m=t.getMonth();return 11===m&&1===w?y++:!m&&51<w&&y--,y+"-"+w;case"months":return t.getFullYear()+"-"+t.getMonth();case"days":default:return new Date(t.getFullYear(),t.getMonth(),t.getDate()).getTime()}},_datesToDays:function(dates){for(var dayMap={},i=0,len=dates.length;i<len;i++)dayMap[tools.dateDeserialize(dates[i]).setHours(0,0,0,0)]=!0;return dayMap},isHoliday:function(){if(!settings.holidays||!settings.holidays.length)return function(){return!1};var holidays=!1;return function(date){return holidays||(holidays=tools._datesToDays(settings.holidays)),!!holidays[$.isNumeric(date)?date:new Date(date.getFullYear(),date.getMonth(),date.getDate()).getTime()]}}(),getCellSize:function(){if(void 0===tools._getCellSize){var measure=$('<div style="display: none; position: absolute;" class="fn-gantt"><div class="row"></div></div>');$("body").append(measure),tools._getCellSize=measure.find(".row").height(),measure.empty().remove()}return tools._getCellSize},getPageHeight:function(element){return element.pageNum+1===element.pageCount?element.rowsOnLastPage*tools.getCellSize():settings.itemsPerPage*tools.getCellSize()}};this.each(function(){if(this.data=null,this.pageNum=0,this.pageCount=0,this.rowsOnLastPage=0,this.rowsNum=0,this.hPosition=0,this.dateStart=null,this.dateEnd=null,this.scrollClicked=!1,this.scaleOldWidth=null,this.headerRows=null,settings.useCookie){var sc=$.cookie(settings.cookieKey+"CurrentScale");sc?settings.scale=sc:$.cookie(settings.cookieKey+"CurrentScale",settings.scale)}switch(settings.scale){case"hours":this.headerRows=5,this.scaleStep=1;break;case"weeks":this.headerRows=3,this.scaleStep=13;break;case"months":this.headerRows=2,this.scaleStep=14;break;case"days":default:this.headerRows=4,this.scaleStep=13}this.scrollNavigation={panelMouseDown:!1,scrollerMouseDown:!1,mouseX:null,panelMargin:0,repositionDelay:0,panelMaxPos:0,canScroll:!0},this.gantt=null,this.loader=null,core.create(this)})}}(jQuery);